@page "/entry"
@using JouralAppWeb.Database
@inject NavigationManager Navigation
@inject AppDbContext Database
@inject JouralAppWeb.Services.AuthService AuthService
@inject IJSRuntime JS

<div class="page">
    <div class="page-header">
        <h2 class="page-title">Today's Journal Entry</h2>
        <small class="text-muted">@DateTime.Today.ToLongDateString()</small>
    </div>

    <EditForm Model="journalEntry" OnValidSubmit="SaveJournal">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Rich Text (Quill) -->
        <div class="form-group">
            <label>Journal Entry</label>

            <!-- Quill editor container -->
            <div id="quillEditor" style="height: 260px; background: white;"></div>

            <small class="text-muted">Word count: @WordCount</small>
        </div>

        <div class="form-group">
            <label>Category</label>
            <input class="form-control"
                   @bind="journalEntry.Category"
                   placeholder="Study, Work, Personal" />
        </div>

        <div class="form-group">
            <label>Primary Mood</label>
            <select class="form-control" @bind="journalEntry.PrimaryMood">
                <option value="">Select mood</option>
                @foreach (var mood in AllMoods)
                {
                    <option value="@mood">@mood</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label>Secondary Moods (max 2)</label>
            @foreach (var mood in AllMoods)
            {
                <div class="form-check">
                    <input type="checkbox"
                           class="form-check-input"
                           checked="@SecondaryMoodList.Contains(mood)"
                           @onchange="e => ToggleSecondaryMood(mood, (bool)e.Value!)"
                           disabled="@(SecondaryMoodList.Count >= 2 && !SecondaryMoodList.Contains(mood))" />
                    <label class="form-check-label">@mood</label>
                </div>
            }
            @if (SecondaryMoodList.Count >= 2)
            {
                <small class="text-warning">Maximum 2 secondary moods selected</small>
            }
        </div>

        <div class="form-group">
            <label>Tags</label>
            <input class="form-control"
                   @bind="TagsInput"
                   placeholder="Work, Study, Family" />
            <small class="text-muted">Separate tags with commas</small>
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary ml-2" @onclick="GoToEntries">
            View Entries
        </button>
    </EditForm>
</div>

@code {
    public JournalEntry journalEntry { get; set; } = new();

    public string TagsInput { get; set; } = "";
    public List<string> SecondaryMoodList { get; set; } = new();

    private int userId;
    private const string EditorId = "quillEditor";
    private bool editorReady = false;

    private readonly List<string> AllMoods = new()
    {
        "Happy", "Calm", "Excited", "Grateful",
        "Sad", "Stressed", "Angry", "Anxious"
    };

    public int WordCount =>
        string.IsNullOrWhiteSpace(journalEntry.Content)
            ? 0
            : StripHtml(journalEntry.Content)
                .Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;

    protected override async Task OnInitializedAsync()
    {
        // ✅ Require login
        if (!AuthService.IsLoggedIn || AuthService.CurrentUser == null)
        {
            Navigation.NavigateTo("/");
            return;
        }

        userId = AuthService.CurrentUser.Id;

        try
        {
            var today = DateTime.Today;
            var tomorrow = today.AddDays(1);

            // ✅ Load today's entry for this user only
            var query = @"
                SELECT * FROM JournalEntries
                WHERE UserId = ?
                  AND EntryDate >= ? AND EntryDate < ?
                LIMIT 1";

            var result = await Database._dbConnection.QueryAsync<JournalEntry>(query, userId, today, tomorrow);
            journalEntry = result.FirstOrDefault();

            if (journalEntry == null)
            {
                journalEntry = new JournalEntry
                {
                    UserId = userId,
                    EntryDate = today,
                    CreatedAt = DateTime.Now,
                    UpdatedAt = DateTime.Now,
                    Content = ""
                };
            }
            else
            {
                SecondaryMoodList = string.IsNullOrWhiteSpace(journalEntry.SecondaryMoods)
                    ? new List<string>()
                    : journalEntry.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries)
                        .Select(s => s.Trim())
                        .Where(s => !string.IsNullOrEmpty(s))
                        .ToList();

                TagsInput = journalEntry.Tags ?? "";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading today's entry: {ex.Message}");
            journalEntry = new JournalEntry
            {
                UserId = userId,
                EntryDate = DateTime.Today,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now,
                Content = ""
            };
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ✅ Initialize Quill editor
            await JS.InvokeVoidAsync("quillEditor.init", EditorId);
            editorReady = true;

            // ✅ Set stored HTML into editor
            await JS.InvokeVoidAsync("quillEditor.setHtml", EditorId, journalEntry.Content ?? "");
        }
    }

    private async Task SaveJournal()
    {
        if (!editorReady)
        {
            await Application.Current.MainPage.DisplayAlert("Error", "Editor is not ready yet.", "OK");
            return;
        }

        // ✅ Read HTML from Quill
        var html = await JS.InvokeAsync<string>("quillEditor.getHtml", EditorId);
        journalEntry.Content = html ?? "";

        // Validate (ignore empty HTML like <p><br></p>)
        if (string.IsNullOrWhiteSpace(StripHtml(journalEntry.Content)))
        {
            await Application.Current.MainPage.DisplayAlert(
                "Validation Error",
                "Please write something in your journal entry.",
                "OK");
            return;
        }

        journalEntry.UserId = userId;
        journalEntry.SecondaryMoods = string.Join(",", SecondaryMoodList);
        journalEntry.Tags = TagsInput;
        journalEntry.EntryDate = DateTime.Today;
        journalEntry.UpdatedAt = DateTime.Now;

        if (journalEntry.CreatedAt == default)
            journalEntry.CreatedAt = DateTime.Now;

        try
        {
            int result;
            if (journalEntry.Id == 0)
            {
                result = await Database._dbConnection.InsertAsync(journalEntry);
            }
            else
            {
                result = await Database._dbConnection.UpdateAsync(journalEntry);
            }

            if (result > 0)
            {
                await Application.Current.MainPage.DisplayAlert("Success", "Saved!", "OK");
                Navigation.NavigateTo("/timeline");
            }
            else
            {
                await Application.Current.MainPage.DisplayAlert("Warning", "Not saved. Try again.", "OK");
            }
        }
        catch (Exception ex)
        {
            await Application.Current.MainPage.DisplayAlert("Error", $"Failed to save: {ex.Message}", "OK");
        }
    }

    private void ToggleSecondaryMood(string mood, bool selected)
    {
        if (selected)
        {
            if (SecondaryMoodList.Count < 2 && !SecondaryMoodList.Contains(mood))
                SecondaryMoodList.Add(mood);
        }
        else
        {
            SecondaryMoodList.Remove(mood);
        }
    }

    private void GoToEntries() => Navigation.NavigateTo("/timeline");

    private static string StripHtml(string? html)
    {
        if (string.IsNullOrWhiteSpace(html)) return "";
        return System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", " ");
    }
}
